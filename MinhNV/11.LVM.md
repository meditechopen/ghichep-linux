# Logical Volume ManagerVề cơ bản Logical Volume Manager trong như thế này: - Logical Volume(s): ``/dev/fileserver/share``, ``/dev/fileserver/backup``, ``/dev/fileserver/media``- Volume Group(s): ``fileserver``- Physical Volume(s): ``/dev/sdb1``, ``/dev/sdc1``, ``/dev/sdd1, /dev/sdc1``Bạn có thể có một hoặc nhiều physical volume và từ những physical volume này bạn tạo một hoặc nhiều group volume. Nếu bạn sử dung nhiều physical volume tạo ra logical volume có thể lớn hơn  physical volumes cơ bản (nhưng tất nhiên tổng  logical volumes không thể vượt quá tổng không gian được cung cấp bởi physical volume).Đó là một cách thực hành tốt để không phân bổ không gian đầy đủ cho  logical volumes, nhưng để lại một không gian không sử dụng. Bằng cách đó bạn có thể mở rộng một hoặc nhiều logical volume sau này nếu bạn cảm thấy cần nó.Với LVM, một ổ cứng hoặc một bộ ổ cứng hoặc các phân vùng khác nhau của cùng một ổ cứng được phân bổ cho một hoặc nhiều physical volume. Physical volume có thể được đặt trên các thiết bị khối khác mà có thể span hai hoặc nhiều đĩa. Các Physical volume được kết hợp thành các khối logic, ngoại trừ phân vùng ``/boot`` đó. Các phân vùng ``/boot``  không thể được vào một logical volume group vì bộ tải khởi động không thể đọc nó. Nếu phân vùng gốc nằm trên một khối lượng hợp lý, hãy tạo một phân vùng riêng biệt ``/boot`` mà không phải là một phần của một volume group. Vì  Physical volume không thể vượt quá nhiều ổ đĩa, để trải dài trên nhiều ổ đĩa, hãy tạo một hoặc nhiều  Physical volume lý trên mỗi ổ đĩa.# Tạo một LVM Trên máy CentOS local của tôi, có thêm trên ổ cứng ``/dev/sdb`` dùng để tạo LVM```sh # fdisk /dev/sdbWelcome to fdisk (util-linux 2.23.2).Disk /dev/sdb: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0004da93   Device Boot      Start         End      Blocks   Id  System/dev/sdb1            2048   488397167   244197560   8e  Linux LVMCommand (m for help):```Trước hết chúng ta cần tạo một physical volume```sh# pvcreate /dev/sdb1  Physical volume "/dev/sdb1" successfully created# pvs  PV         VG   Fmt  Attr PSize   PFree  /dev/sdb1       lvm2 ---  232.88g 232.88g# pvscan  PV  /dev/sdb1           lvm2 [232.88 GiB]  Total: 3 [465.28 GiB] / in use: 2 [232.39 GiB] / in no VG: 1 [232.88 GiB]# pvdisplay "/dev/sdb1" is a new physical volume of "232.88 GiB"  --- NEW Physical volume ---  PV Name               /dev/sdb1  VG Name  PV Size               232.88 GiB  Allocatable           NO  PE Size               0  Total PE              0  Free PE               0  Allocated PE          0  PV UUID               ajGCMg-Y4cG-v4AD-Wxma-TaE5-zQig-XmnYAx```Bây giờ tạo  volume group```sh# vgcreate storage /dev/sdb1  Volume group "storage" successfully created# vgscan  Reading all physical volumes.  This may take a while...  Found volume group "storage" using metadata type lvm2# vgs  VG      #PV #LV #SN Attr   VSize   VFree  storage   1   0   0 wz--n- 232.88g 232.88g# vgdisplay  --- Volume group ---  VG Name               storage  System ID  Format                lvm2  Metadata Areas        1  Metadata Sequence No  1  VG Access             read/write  VG Status             resizable  MAX LV                0  Cur LV                0  Open LV               0  Max PV                0  Cur PV                1  Act PV                1  VG Size               232.88 GiB  PE Size               4.00 MiB  Total PE              59618  Alloc PE / Size       0 / 0  Free  PE / Size       59618 / 232.88 GiB  VG UUID               nEcTxG-p5K6-npqD-OVeX-dRI1-aWP9-o4D1Z1```Tạo logical volumes từ volume group```sh# lvcreate -L 20G -n db-area storage  Logical volume "db-area" created.# lvcreate -L 10G -n users-area storage  Logical volume "users-area" created.# lvcreate -L 60G -n staging-area storage  Logical volume "staging-area" created.# lvcreate -l 100%FREE -n spare storage  Logical volume "spare" created.# lvs  LV           VG      Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert  db-area      storage -wi-a-----  20.00g  spare        storage -wi-a----- 142.88g  staging-area storage -wi-a-----  60.00g  users-area   storage -wi-a-----  10.00g# lvscan  ACTIVE            '/dev/storage/db-area' [20.00 GiB] inherit  ACTIVE            '/dev/storage/users-area' [10.00 GiB] inherit  ACTIVE            '/dev/storage/staging-area' [60.00 GiB] inherit  ACTIVE            '/dev/storage/spare' [142.88 GiB] inherit```Tiến hành Mount và sử dung```sh# mkfs.ext4 /dev/storage/db-area# mkfs.ext4 /dev/storage/users-area# mkfs.ext4 /dev/storage/staging-area# mkfs.ext4 /dev/storage/spare# mkdir /db# mount /dev/storage/db-area /db# mkdir /users# mount /dev/storage/users-area /users# mkdir /staging# mount /dev/storage/staging-area /staging```# Thay đổi dung lượng trên LVMTrên máy CentOS local có 2 ổ cứng /dev/sdavà /dev/sdb. ```sh# fdisk -l /dev/sdaDisk /dev/sda: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x000b78bc   Device Boot      Start         End      Blocks   Id  System/dev/sda1   *        2048     1026047      512000   83  Linux/dev/sda2         1026048   155004927    76989440   8e  Linux LVM/dev/sda3       155004928   488397167   166696120   83  Linux LVM```Các /dev/sda1là dành cho các phân vùng /boot. Cả hai /dev/sda2và /dev/sda3 là một phần của bố cục LVM. Lưu ý rằng cả hai phân vùng là một phần của cùng một đĩa vật lý. Đây không phải là phổ biến trong sản xuất nhưng có thể có. Phổ biến hơn là trường hợp các phân vùng thuộc các đĩa vật lý khác nhau.```sh# lvmdiskscan  /dev/os/swap [       3.89 GiB]  /dev/sda1    [     500.00 MiB]  /dev/os/root [      50.00 GiB]  /dev/sda2    [      73.42 GiB] LVM physical volume  /dev/os/data [     178.50 GiB]  /dev/sda3    [     158.97 GiB] LVM physical volume  /dev/sdb1    [     232.88 GiB]  3 disks  2 partitions  0 LVM physical volume whole disks  2 LVM physical volumes# pvs  PV         VG   Fmt  Attr PSize   PFree  /dev/sda2  os   lvm2 a--   73.42g    0  /dev/sda3  os   lvm2 a--  158.97g    0# vgs  VG   #PV #LV #SN Attr   VSize   VFree  os     2   3   0 wz--n- 232.39g    0# lvs  LV   VG   Attr       LSize   Pool Origin Data%  Move Log Cpy%Sync Convert  data os   -wi-ao---- 178.50g  root os   -wi-ao----  50.00g  swap os   -wi-ao----   3.89g```Chúng tôi muốn tăng không gian của bố cục LVM với một phân vùng mới thuộc ổ cứng thứ hai /dev/sdb. Ổ đĩa cứng được phân chia như sau:```sh# fdisk -l /dev/sdbDisk /dev/sdb: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0004da93   Device Boot      Start         End      Blocks   Id  System/dev/sdb1            2048   488397167   244197560   83  Linux```Phân vùng /dev/sdb1là loại Linux. Thay đổi kiểu phân vùng thành Linux LVM```sh# fdisk /dev/sdbWelcome to fdisk (util-linux 2.23.2).Changes will remain in memory only, until you decide to write them.Be careful before using the write command.Command (m for help): pDisk /dev/sdb: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0004da93   Device Boot      Start         End      Blocks   Id  System/dev/sdb1            2048   488397167   244197560   83  LinuxCommand (m for help): tSelected partition 1Hex code (type L to list all codes): 8eChanged type of partition 'Linux' to 'Linux LVM'Command (m for help): pDisk /dev/sdb: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0004da93   Device Boot      Start         End      Blocks   Id  System/dev/sdb1            2048   488397167   244197560   8e  Linux LVMCommand (m for help): wThe partition table has been altered!Calling ioctl() to re-read partition table.WARNING: Re-reading the partition table failed with error 16: Device or resource busy.The kernel still uses the old table. The new table will be used atthe next reboot or after you run partprobe(8) or kpartx(8)Syncing disks.```Tạo một physical volume từ một partition mới ```sh# pvcreate /dev/sdb1WARNING: xfs signature detected on /dev/sdb1 at offset 0. Wipe it? [y/n] y  Wiping xfs signature on /dev/sdb1.  Physical volume "/dev/sdb1" successfully created```Dùng lệnh pvdisplay để kiểm tra physical volume đã tạo ```sh# pvdisplay   "/dev/sdb1" is a new physical volume of "232.88 GiB"  --- NEW Physical volume ---  PV Name               /dev/sdb1  VG Name  PV Size               232.88 GiB  Allocatable           NO  PE Size               0  Total PE              0  Free PE               0  Allocated PE          0  PV UUID               qtRwhD-Pxcv-JQlD-u7xu-lNi0-CiBv-F9XUoO```Bây giờ mở rộng volume group ``os``  bằng cách thêm vào physical volume mới mà chúng tôi tạo ra trước đó```sh# vgextend os /dev/sdb1  Volume group "os" successfully extended```Sử dung lệnh pvscan mà chúng ta quét tất cả các đĩa cho khối lượng vật lý, điều này sẽ xác nhận physical volume mới tạo ra /dev/sdb1 và cùng với volume cũ```sh# pvscan  PV /dev/sda2   VG os   lvm2 [73.42 GiB / 0    free]  PV /dev/sda3   VG os   lvm2 [158.97 GiB / 0    free]  PV /dev/sdb1   VG os   lvm2 [232.88 GiB / 232.88 GiB free]  Total: 3 [465.28 GiB] / in use: 3 [465.28 GiB] / in no VG: 0 [0   ]```Tiếp theo muốn tăng  logic volume /dev/os/data mà về cơ bản có nghĩa là chúng ta sẽ lấy  logic volume ban đầu /dev/os/data và mở rộng nó trên khối lượng vật lý mới /dev/sdb1 vừa được tạo ra```sh# lvscan  ACTIVE            '/dev/os/root' [50.00 GiB] inherit  ACTIVE            '/dev/os/swap' [3.89 GiB] inherit  ACTIVE            '/dev/os/data' [178.50 GiB] inherit# lvextend /dev/os/data /dev/sdb1  Extending logical volume data to 411.39 GiB  Logical volume data successfully resized# lvscan  ACTIVE            '/dev/os/root' [50.00 GiB] inherit  ACTIVE            '/dev/os/swap' [3.89 GiB] inherit  ACTIVE            '/dev/os/data' [411.39 GiB] inherit```Lưu ý kích thước của logical volume /dev/os/data tăng từ 178,50 GiB lên 411,39 GiB. Tuy nhiên, kích thước của /datahệ thống tập tin vẫn còn 179g```sh # df -hFilesystem           Size  Used Avail Use% Mounted on/dev/mapper/os-root   50G  2.0G   48G   4% /devtmpfs             1.8G     0  1.8G   0% /devtmpfs                1.9G     0  1.9G   0% /dev/shmtmpfs                1.9G  8.6M  1.8G   1% /runtmpfs                1.9G     0  1.9G   0% /sys/fs/cgroup/dev/mapper/os-data  179G   33M  179G   1% /data/dev/sda1            497M  183M  315M  37% /boot```Sau đó có một bước cuối cùng là thay đổi kích thước hệ thống tập tin để nó có thể tận dụng không gian bổ sung này, điều này được thực hiện bằng cách sử dung lệnh ``resize2fs``. Trong trường hợp của chúng tôi, lệnh sẽ không thành công vì chúng ta đang sử dụng hệ thống tệp tin xfs . Chúng ta cần phải sử dụng xfs_growfsđể có cùng hiệu quả.```sh# xfs_growfs /dev/os/datameta-data=/dev/mapper/os-data    isize=256    agcount=4, agsize=11698432 blks         =                       sectsz=512   attr=2, projid32bit=1         =                       crc=0data     =                       bsize=4096   blocks=46793728, imaxpct=25         =                       sunit=0      swidth=0 blksnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0log      =internal               bsize=4096   blocks=22848, version=2         =                       sectsz=512   sunit=0 blks, lazy-count=1realtime =none                   extsz=4096   blocks=0, rtextents=0data blocks changed from 46793728 to 107842560# df -hFilesystem           Size  Used Avail Use% Mounted on/dev/mapper/os-root   50G  2.0G   48G   4% /devtmpfs             1.8G     0  1.8G   0% /devtmpfs                1.9G     0  1.9G   0% /dev/shmtmpfs                1.9G  8.6M  1.8G   1% /runtmpfs                1.9G     0  1.9G   0% /sys/fs/cgroup/dev/mapper/os-data  412G   33M  412G   1% /data/dev/sda1            497M  183M  315M  37% /boot```# Giảm bố cục LVMKhông may chúng ta không thể tạo một phân vùng XFS trực tuyến nhỏ hơn. Cách duy nhất để thu nhỏ là làm một bãi chứa hoàn chỉnh dữ liệu, tạo một nhóm nhỏ hơn mới và khôi phục lại dữ liệu.```sh# mkdir /dump# mv /data/* /dump/# umount /data```Loại bỏ  logical volume /dev/os/data```sh# lvremove /dev/os/dataDo you really want to remove active logical volume data? [y/n]: y  Logical volume "data" successfully removed# lvscan  ACTIVE            '/dev/os/root' [50.00 GiB] inherit  ACTIVE            '/dev/os/swap' [3.89 GiB] inherit```Sử dụng lệnh vgreduce. Lệnh này làm giảm khả năng của một volume group bằng cách loại bỏ một hoặc nhiều physical volumes. Điều này giải phóng physical volumes sẽ được sử dụng trong các group volume khác hoặc sẽ được loại bỏ khỏi hệ thống.```sh# vgreduce os /dev/sdb1  Removed "/dev/sdb1" from volume group "os"# pvs  PV         VG   Fmt  Attr PSize   PFree  /dev/sda2  os   lvm2 a--   73.42g  19.53g  /dev/sda3  os   lvm2 a--  158.97g 158.97g  /dev/sdb1       lvm2 a--  232.88g 232.88g```Loại bỏ physical volume```sh# pvremove /dev/sdb1  Labels on physical volume "/dev/sdb1" successfully wiped# pvs  PV         VG   Fmt  Attr PSize   PFree  /dev/sda2  os   lvm2 a--   73.42g  19.53g  /dev/sda3  os   lvm2 a--  158.97g 158.97g```Tạo lại logical volume /dev/os/data  với không gian còn lại trong volume group os  ```sh# lvcreate -l 100%FREE -n data osWARNING: xfs signature detected on /dev/os/data at offset 0. Wipe it? [y/n] y  Wiping xfs signature on /dev/os/data.  Logical volume "data" created# lvscan  ACTIVE            '/dev/os/root' [50.00 GiB] inherit  ACTIVE            '/dev/os/swap' [3.89 GiB] inherit  ACTIVE            '/dev/os/data' [178.50 GiB] inherit```Định dạng lại volume group vừa tạo ```sh# mkfs.xfs -f /dev/os/datameta-data=/dev/os/data           isize=256    agcount=4, agsize=11698432 blks         =                       sectsz=512   attr=2, projid32bit=1         =                       crc=0data     =                       bsize=4096   blocks=46793728, imaxpct=25         =                       sunit=0      swidth=0 blksnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0log      =internal log           bsize=4096   blocks=22848, version=2         =                       sectsz=512   sunit=0 blks, lazy-count=1realtime =none                   extsz=4096   blocks=0, rtextents=0# mount -a# # df -ThFilesystem          Type      Size  Used Avail Use% Mounted on/dev/mapper/os-root xfs        50G  2.0G   48G   4% /devtmpfs            devtmpfs  1.8G     0  1.8G   0% /devtmpfs               tmpfs     1.9G     0  1.9G   0% /dev/shmtmpfs               tmpfs     1.9G  8.5M  1.8G   1% /runtmpfs               tmpfs     1.9G     0  1.9G   0% /sys/fs/cgroup/dev/sda1           xfs       497M  183M  315M  37% /boot/dev/mapper/os-data xfs       179G   33M  179G   1% /data# # mv /dump/* /data/```Cuối cùng, thay đổi kiểu phân vùng /dev/sdb1trở lại Linux (không LVM), định dạng là XFS và gắn kết nó như là một phân vùng vật lý tiêu chuẩn```sh# fdisk /dev/sdbWelcome to fdisk (util-linux 2.23.2).Changes will remain in memory only, until you decide to write them.Be careful before using the write command.Command (m for help): pDisk /dev/sdb: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0004da93   Device Boot      Start         End      Blocks   Id  System/dev/sdb1            2048   488397167   244197560   8e  Linux LVMCommand (m for help): tSelected partition 1Hex code (type L to list all codes): 83Changed type of partition 'Linux LVM' to 'Linux'Command (m for help): pDisk /dev/sdb: 250.1 GB, 250059350016 bytes, 488397168 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0004da93   Device Boot      Start         End      Blocks   Id  System/dev/sdb1            2048   488397167   244197560   83  LinuxCommand (m for help): wThe partition table has been altered!Calling ioctl() to re-read partition table.Syncing disks.# mkfs.xfs -f /dev/sdb1meta-data=/dev/sdb1              isize=256    agcount=4, agsize=15262348 blks         =                       sectsz=512   attr=2, projid32bit=1         =                       crc=0data     =                       bsize=4096   blocks=61049390, imaxpct=25         =                       sunit=0      swidth=0 blksnaming   =version 2              bsize=4096   ascii-ci=0 ftype=0log      =internal log           bsize=4096   blocks=29809, version=2         =                       sectsz=512   sunit=0 blks, lazy-count=1realtime =none                   extsz=4096   blocks=0, rtextents=0# mount -a# df -ThFilesystem          Type      Size  Used Avail Use% Mounted on/dev/mapper/os-root xfs        50G  2.0G   48G   4% /devtmpfs            devtmpfs  1.8G     0  1.8G   0% /devtmpfs               tmpfs     1.9G     0  1.9G   0% /dev/shmtmpfs               tmpfs     1.9G  8.5M  1.8G   1% /runtmpfs               tmpfs     1.9G     0  1.9G   0% /sys/fs/cgroup/dev/sda1           xfs       497M  183M  315M  37% /boot/dev/mapper/os-data xfs       179G   33M  179G   1% /data/dev/sdb1           xfs       233G   33M  233G   1% /cinder-volumes#```