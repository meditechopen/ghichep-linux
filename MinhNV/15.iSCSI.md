# Lưu trữ chia sẻ trên mạng với iSCSICó nhiều cách để chia sẻ lưu trữ trên mạng. Giao thức iSCSI xác định một cách để xem thiết bị khối từ xa dưới dạng đĩa cục bộ. Một thiết bị từ xa trên mạng được gọi là iSCSI Target, một máy khách kết nối với iSCSI Target được gọi là Initiator iSCSI.# Cài đặt iSCSI```sh# yum -y install targetcli# systemctl enable target# systemctl start target```Để bắt đầu sử dụng ``targetcli``, dùng lệnh ``ls`` để hiển thị bố cục dạng cây```sh# targetclitargetcli shell version 2.1.fb37Copyright 2011-2013 by Datera, Inc and others.For help on commands, type 'help'./> lso- / .............................................................................................................. [...]  o- backstores ................................................................................................... [...]  | o- block ....................................................................................... [Storage Objects: 0]  | o- fileio ...................................................................................... [Storage Objects: 0]  | o- pscsi ....................................................................................... [Storage Objects: 0]  | o- ramdisk ..................................................................................... [Storage Objects: 0]  o- iscsi ................................................................................................. [Targets: 0]  o- loopback .............................................................................................. [Targets: 0]/>```# Tạo backstoreBackstores cho phép hỗ trợ cho các phương pháp khác nhau của lưu trữ một đối tượng trên máy local. Tạo một đối tượng lưu trữ xác định các tài nguyên mà backstore sẽ sử dụng. Các backstores được hỗ trợ là: các thiết bị khối, các tệp tin, pscsi và ramdisks. Chặn thiết bị là trong trường hợp của chúng tôi.```sh/> /backstores/block create name=block_storage dev=/dev/sdb1Generating a wwn serial.Created block storage object block_backend using /dev/sdb1.```# Tạo một  iSCSI TargetTạo một iSCSI Target bằng cách sử dụng một tên được chỉ định```sh/> iscsi/ create iqn.2015-05.com.noverit.caldara02:3260Created target iqn.2015-05.com.noverit.caldara02:3260.Created TPG 1.```# Cấu hình iSCSI PortalCổng iSCSI là một đối tượng xác định địa chỉ IP và cổng nơi đích iSCSI lắng nghe các kết nối đến```sh/> /iscsi/iqn.2015-05.com.noverit.caldara02:3260/tpg1/portals/ createUsing default IP port 3260Binding to INADDR_ANY (0.0.0.0)Created network portal 0.0.0.0:3260```Theo mặc định, một cổng thông tin được tạo ra khi  iSCSI target được tạo nghe trên tất cả các địa chỉ IP (0.0.0.0) và cổng iSCSI mặc định 3260. Hãy chắc chắn rằng 3260 không được ứng dụng khác sử dụng.# Cấu hình danh sách truy cập Tạo một Access List cho mỗi initiator sẽ được kết nối đến mục tiêu. Điều này thực thi chứng thực khi khởi động kết nối, cho phép chỉ LUNs được tiếp xúc với mỗi người khởi tạo. Thông thường mỗi người khởi tạo đều có quyền truy cập độc quyền vào LUN. Tất cả người khởi tạo đều có tên xác định duy nhất IQN. IQN duy nhất của người khởi tạo phải được biết để cấu hình ACL. Đối với người khởi tạo open-iscsi, điều này có thể được tìm thấy trong ``/etc/iscsi/initiatorname.iscsi`` .```sh/> /iscsi/iqn.2015-05.com.noverit.caldara02:3260/tpg1/luns/ create /backstores/block/block_storageCreated LUN 0.```Cuối cùng iSCSI target envinronment  sẽ giống như sau ```sh/> lso- / ........................................................................................................... [...]  o- backstores ................................................................................................ [...]  | o- block .................................................................................... [Storage Objects: 2]  | | o- ana-storage ...................................................... [/dev/sdb1 (20.0GiB) write-thru activated]  | | o- oracle-storage .................................................. [/dev/sdb2 (120.0GiB) write-thru activated]  | o- fileio ................................................................................... [Storage Objects: 0]  | o- pscsi .................................................................................... [Storage Objects: 0]  | o- ramdisk .................................................................................. [Storage Objects: 0]  o- iscsi .............................................................................................. [Targets: 1]  | o- iqn.2015-05.com.noverit.caldara02:3260 .............................................................. [TPGs: 1]  |   o- tpg1 .................................................................................... [gen-acls, no-auth]  |     o- acls ............................................................................................ [ACLs: 0]  |     o- luns ............................................................................................ [LUNs: 2]  |     | o- lun0 .................................................................... [block/ana-storage (/dev/sdb1)]  |     | o- lun1 ................................................................. [block/oracle-storage (/dev/sdb2)]  |     o- portals ...................................................................................... [Portals: 1]  |       o- 10.10.10.98:3260 ................................................................................... [OK]  o- loopback ........................................................................................... [Targets: 0]/>/> exitGlobal pref auto_save_on_exit=trueLast 10 configs saved in /etc/target/backup.Configuration saved to /etc/target/saveconfig.json```Tập tin ``/etc/target/saveconfig.json`` có chứa các cấu hình trên.Khởi động lại dịch vụ target ```sh# service target restartRedirecting to /bin/systemctl restart  target.service```# Thiết lập iSCSI InitiatorSau khi cấu hình iSCSI trên máy đích, di chuyển đến thiết lập máy khởi tạo iSCSI. Cài đặt công cụ quản trị ```# yum -y install iscsi-initiator-utils```Cho phép khởi động 2 dịch vụ iscsi và iscsid cùng hệ thống ```sh# service iscsid start# service iscsi start# service iscsid status# service iscsi status# chkconfig iscsi on# chkconfig iscsid on# chkconfig --list | grep iscsiiscsi           0:off   1:off   2:off   3:on    4:on    5:on    6:offiscsid          0:off   1:off   2:on    3:on    4:on    5:on    6:off```Kiểm tra tài nguyên iSCSI và đăng nhập ```sh# iscsiadm --mode discovery --type sendtargets --portal caldara02:3260 --discover10.10.10.98:3260,1 iqn.2015-05.com.noverit.caldara02:3260# iscsiadm --mode node --targetname iqn.2015-05.com.noverit.caldara02:3260 --portal caldara02:3260 --loginLogging in to [iface: default, target: iqn.2015-05.com.noverit.caldara02:3260, portal: 10.10.10.98,3260] (multiple)Login to [iface: default, target: iqn.2015-05.com.noverit.caldara02:3260, portal: 10.10.10.98,3260] successful.#```Kiểm tra các thiết bị khối lưu trữ.```sh[root@caldara01 ~]# lsblkNAME                      MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTsda                         8:0    0 232.9G  0 disk├─sda1                      8:1    0   500M  0 part /boot├─sda2                      8:2    0  73.4G  0 part│ ├─os-swap               253:0    0   3.9G  0 lvm  [SWAP]│ ├─os-root               253:1    0    50G  0 lvm  /│ └─os-data               253:2    0 178.5G  0 lvm  /data└─sda3                      8:3    0   159G  0 part  └─os-data               253:2    0 178.5G  0 lvm  /datasdc                         8:32   0    20G  0 disksdd                         8:48   0   120G  0 disk```Hai đĩa /dev/sdc và /dev/sdd là thiết bị khối iSCSI từ target. Chúng được xem như các thiết bị khối địa phương trong máy khởi. Các đĩa có thể được sử dụng như là tiêu chuẩn đĩa cục bộ lệnh và cấu hình, bao gồm fdisk, mkfs, e2label, vv...```sh# e2label /dev/sdc ANA# e2label /dev/sdd ORACLE# mkdir /ana# mkdir /oracle# mount -L ANA /ana# mount -L ORACLE /oracle# df -hFilesystem           Size  Used Avail Use% Mounted on/dev/mapper/os-root   50G  2.8G   48G   6% /devtmpfs             3.8G     0  3.8G   0% /devtmpfs                3.8G     0  3.8G   0% /dev/shmtmpfs                3.8G  370M  3.4G  10% /runtmpfs                3.8G     0  3.8G   0% /sys/fs/cgroup/dev/mapper/os-data  179G   22G  158G  12% /data/dev/sda1            497M  228M  270M  46% /boot/dev/sdc              20G   45M   19G   1% /ana/dev/sdd             118G   60M  112G   1% /oracle```Để ngắt kết nối các thiết bị từ xa, umount và đăng xuất```sh# umount /ana# umount /oracle##  iscsiadm --mode node --targetname iqn.2015-05.com.noverit.caldara02:3260 --portal 10.10.10.98 --logoutLogging out of session [sid: 10, target: iqn.2015-05.com.noverit.caldara02:3260, portal: 10.10.10.98,3260]Logout of [sid: 10, target: iqn.2015-05.com.noverit.caldara02:3260, portal: 10.10.10.98,3260] successful.#```Dừng lại và sau đó vô hiệu hóa các dịch vụ khi khởi động, nếu cần```sh# service iscsid statusiscsid (pid  1184) is running...# service iscsi statusNo active sessions# service iscsid stopStopping iscsid:                      [  OK  ]# service iscsi stopStopping iscsi:                       [  OK  ]# chkconfig iscsid off# chkconfig iscsi off# chkconfig --list | grep iscsiiscsi           0:off   1:off   2:off   3:off   4:off   5:off   6:offiscsid          0:off   1:off   2:off   3:off   4:off   5:off   6:off```